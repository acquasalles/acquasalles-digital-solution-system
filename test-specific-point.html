<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Diagn√≥stico - Torneira da pia</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .section h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        .step {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #007acc;
        }
        .result {
            background: #0e0e0e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 12px;
            overflow-x: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        .log-entry {
            border-left: 2px solid #666;
            padding-left: 10px;
            margin: 5px 0;
        }
        .code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            color: #ce9178;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico - Torneira da pia (BENEFICIAMENTO)</h1>

    <div class="section">
        <h2>üìã Informa√ß√µes do Teste</h2>
        <div class="result">
            <strong class="info">Cliente ID:</strong> <span class="code">17469701015018</span><br>
            <strong class="info">√Årea:</strong> <span class="code">BENEFICIAMENTO</span><br>
            <strong class="info">Ponto:</strong> <span class="code">Torneira da pia</span>
        </div>
    </div>

    <div class="section">
        <h2>üîß Configura√ß√£o</h2>
        <div class="step">
            <p>1. Configure as credenciais do Supabase abaixo:</p>
            <input type="text" id="supabaseUrl" placeholder="Supabase URL" style="width: 100%; padding: 8px; margin: 5px 0;">
            <input type="password" id="supabaseKey" placeholder="Supabase Anon Key" style="width: 100%; padding: 8px; margin: 5px 0;">
            <button onclick="saveCredentials()">üíæ Salvar Credenciais</button>
            <button onclick="loadFromEnv()">üìÅ Carregar do .env</button>
        </div>
    </div>

    <div class="section">
        <h2>üöÄ Testes de Diagn√≥stico</h2>
        <button onclick="runTest1()">1Ô∏è‚É£ Verificar se ponto existe</button>
        <button onclick="runTest2()">2Ô∏è‚É£ Buscar medi√ß√µes (√∫ltimos 90 dias)</button>
        <button onclick="runTest3()">3Ô∏è‚É£ Verificar tipos de medi√ß√£o</button>
        <button onclick="runTest4()">4Ô∏è‚É£ Simular query do frontend</button>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Executar Todos</button>
        <button onclick="clearResults()">üóëÔ∏è Limpar</button>
    </div>

    <div id="results" class="section">
        <h2>üìä Resultados</h2>
        <div id="resultsContent" class="result">
            <em class="warning">Aguardando execu√ß√£o dos testes...</em>
        </div>
    </div>

    <div class="section">
        <h2>üí° Instru√ß√µes</h2>
        <div class="result">
            <p><strong>Como usar:</strong></p>
            <ol>
                <li>Abra o arquivo <span class="code">.env</span> do projeto</li>
                <li>Copie o valor de <span class="code">VITE_SUPABASE_URL</span> e <span class="code">VITE_SUPABASE_ANON_KEY</span></li>
                <li>Cole nos campos acima e clique em "Salvar Credenciais"</li>
                <li>Execute os testes clicando nos bot√µes azuis</li>
                <li>Analise os resultados para identificar o problema</li>
            </ol>
            <p><strong class="warning">‚ö†Ô∏è Importante:</strong> Esta p√°gina deve ser servida pelo mesmo servidor da aplica√ß√£o para evitar problemas de CORS.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const CLIENT_ID = '17469701015018';
        const AREA_NAME = 'BENEFICIAMENTO';
        const PONTO_NAME = 'Torneira da pia';

        let supabase = null;

        // Wait for Supabase library to load
        function waitForSupabase() {
            return new Promise((resolve) => {
                if (window.supabase) {
                    resolve();
                } else {
                    setTimeout(() => waitForSupabase().then(resolve), 100);
                }
            });
        }

        function log(message, type = 'info') {
            const colors = {
                info: '#569cd6',
                success: '#4ec9b0',
                error: '#f48771',
                warning: '#dcdcaa'
            };
            const timestamp = new Date().toLocaleTimeString();
            const entry = `<div class="log-entry" style="border-color: ${colors[type]}">
                <span style="color: #666">[${timestamp}]</span>
                <span style="color: ${colors[type]}">${message}</span>
            </div>`;
            document.getElementById('resultsContent').innerHTML += entry;
        }

        function clearResults() {
            document.getElementById('resultsContent').innerHTML = '<em class="warning">Resultados limpos. Execute os testes novamente.</em>';
        }

        async function saveCredentials() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                log('‚ùå Por favor, preencha ambos os campos!', 'error');
                return;
            }

            try {
                // Wait for Supabase library to load
                if (typeof window.supabase === 'undefined') {
                    log('‚è≥ Aguardando biblioteca Supabase...', 'warning');
                    await waitForSupabase();
                }

                // Use the global supabase object
                const { createClient } = window.supabase;
                supabase = createClient(url, key);
                log('‚úÖ Credenciais configuradas com sucesso!', 'success');
                log('üîó Conectado ao Supabase', 'info');
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        async function loadFromEnv() {
            log('üîÑ Carregando credenciais...', 'info');

            const url = 'https://wanrdteafvqtcivcrtfy.supabase.co';
            const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbnJkdGVhZnZxdGNpdmNydGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM1ODk1MjYsImV4cCI6MjAzOTE2NTUyNn0.Ji_C9y4YUzuD4desS-ln6AVsNY_rfWu4hcn4wu4Zb38';

            document.getElementById('supabaseUrl').value = url;
            document.getElementById('supabaseKey').value = key;

            await saveCredentials();
        }

        async function runTest1() {
            if (!supabase) {
                log('‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            log('üîç Teste 1: Verificando se o ponto de coleta existe...', 'info');

            try {
                const { data, error } = await supabase
                    .from('ponto_de_coleta')
                    .select(`
                        id,
                        nome,
                        cliente_id,
                        area_de_trabalho:area_de_trabalho_id (
                            id,
                            nome_area
                        )
                    `)
                    .eq('cliente_id', CLIENT_ID)
                    .eq('nome', PONTO_NAME);

                if (error) {
                    log(`‚ùå Erro na query: ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    log('‚ùå PROBLEMA: Ponto de coleta n√£o encontrado!', 'error');
                    log('üí° Verifique se o nome est√° correto (case-sensitive)', 'warning');
                    return;
                }

                const ponto = data.find(p => p.area_de_trabalho?.nome_area === AREA_NAME);

                if (!ponto) {
                    log('‚ùå PROBLEMA: Ponto existe mas n√£o na √°rea BENEFICIAMENTO', 'error');
                    log(`üìä Pontos encontrados com esse nome:`, 'info');
                    data.forEach(p => {
                        log(`   - √Årea: ${p.area_de_trabalho?.nome_area || 'SEM √ÅREA'}`, 'info');
                    });
                    return;
                }

                log('‚úÖ Ponto de coleta encontrado!', 'success');
                log(`   ID: ${ponto.id}`, 'success');
                log(`   Nome: ${ponto.nome}`, 'success');
                log(`   √Årea: ${ponto.area_de_trabalho.nome_area}`, 'success');

                window.pontoId = ponto.id;

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function runTest2() {
            if (!supabase) {
                log('‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            if (!window.pontoId) {
                log('‚ö†Ô∏è Execute o Teste 1 primeiro para obter o ID do ponto', 'warning');
                return;
            }

            log('üîç Teste 2: Buscando medi√ß√µes (√∫ltimos 90 dias)...', 'info');

            const dataInicio = new Date();
            dataInicio.setDate(dataInicio.getDate() - 90);
            const startDate = dataInicio.toISOString().split('T')[0];

            try {
                const { data, error } = await supabase
                    .from('medicao')
                    .select(`
                        id,
                        data_hora_medicao,
                        medicao_items (
                            id,
                            valor,
                            tipo_medicao:tipo_medicao_id (
                                nome
                            )
                        )
                    `)
                    .eq('cliente_id', CLIENT_ID)
                    .eq('ponto_de_coleta_id', window.pontoId)
                    .gte('data_hora_medicao', startDate)
                    .order('data_hora_medicao', { ascending: false });

                if (error) {
                    log(`‚ùå Erro na query: ${error.message}`, 'error');
                    return;
                }

                log(`üìä Total de medi√ß√µes encontradas: ${data?.length || 0}`, 'info');

                if (!data || data.length === 0) {
                    log('‚ùå PROBLEMA: Nenhuma medi√ß√£o nos √∫ltimos 90 dias', 'error');
                    log('üí° As medi√ß√µes podem estar mais antigas', 'warning');
                    log('üí° Execute uma query sem filtro de data no Supabase', 'warning');
                    return;
                }

                log('‚úÖ Medi√ß√µes encontradas!', 'success');
                log(`   Primeira: ${new Date(data[data.length-1].data_hora_medicao).toLocaleDateString()}`, 'success');
                log(`   √öltima: ${new Date(data[0].data_hora_medicao).toLocaleDateString()}`, 'success');

                window.medicoes = data;

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function runTest3() {
            if (!window.medicoes) {
                log('‚ö†Ô∏è Execute o Teste 2 primeiro', 'warning');
                return;
            }

            log('üîç Teste 3: Analisando tipos de medi√ß√£o...', 'info');

            const tipos = new Set();
            const tiposCount = {};

            window.medicoes.forEach(m => {
                if (m.medicao_items) {
                    m.medicao_items.forEach(item => {
                        const tipo = item.tipo_medicao?.nome;
                        if (tipo) {
                            tipos.add(tipo);
                            tiposCount[tipo] = (tiposCount[tipo] || 0) + 1;
                        }
                    });
                }
            });

            log(`üìä Tipos encontrados: ${tipos.size}`, 'info');

            tipos.forEach(tipo => {
                const count = tiposCount[tipo];
                if (tipo === 'Foto') {
                    log(`   - ${tipo}: ${count} (‚ö†Ô∏è FILTRADO dos gr√°ficos)`, 'warning');
                } else {
                    log(`   - ${tipo}: ${count} (‚úÖ V√ÅLIDO para gr√°fico)`, 'success');
                }
            });

            const tiposValidos = Array.from(tipos).filter(t => t !== 'Foto');

            if (tiposValidos.length === 0) {
                log('‚ùå PROBLEMA ENCONTRADO: Apenas medi√ß√µes tipo "Foto"!', 'error');
                log('üí° Gr√°ficos s√≥ exibem medi√ß√µes num√©ricas (pH, Cloro, Turbidez, Volume, etc.)', 'warning');
                log('üí° Adicione medi√ß√µes de outros tipos para exibir o gr√°fico', 'warning');
                return;
            }

            log('‚úÖ Tipos v√°lidos encontrados para gr√°fico!', 'success');
        }

        async function runTest4() {
            if (!supabase || !window.pontoId) {
                log('‚ö†Ô∏è Execute os testes anteriores primeiro', 'warning');
                return;
            }

            log('üîç Teste 4: Simulando query exata do frontend (√∫ltimos 30 dias)...', 'info');

            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            const start = startDate.toISOString().split('T')[0];
            const end = endDate.toISOString().split('T')[0];

            log(`   Per√≠odo: ${start} at√© ${end}`, 'info');

            try {
                const { data, error } = await supabase
                    .from('medicao')
                    .select(`
                        id,
                        data_hora_medicao,
                        area_de_trabalho:area_de_trabalho_id (
                            nome_area
                        ),
                        ponto_de_coleta:ponto_de_coleta_id (
                            nome,
                            area_de_trabalho_id,
                            outorga
                        ),
                        medicao_items!inner (
                            id,
                            valor,
                            tipo_medicao:tipo_medicao_id (
                                id,
                                nome
                            )
                        )
                    `)
                    .eq('cliente_id', CLIENT_ID)
                    .eq('ponto_de_coleta_id', window.pontoId)
                    .gte('data_hora_medicao', start)
                    .lte('data_hora_medicao', end + 'T23:59:59')
                    .order('data_hora_medicao', { ascending: true });

                if (error) {
                    log(`‚ùå Erro na query: ${error.message}`, 'error');
                    return;
                }

                log(`üìä Resultado: ${data?.length || 0} medi√ß√µes`, 'info');

                if (!data || data.length === 0) {
                    log('‚ùå PROBLEMA: Query do frontend retorna 0 medi√ß√µes', 'error');
                    log('üí° Poss√≠veis causas:', 'warning');
                    log('   1. Medi√ß√µes fora do per√≠odo de 30 dias', 'warning');
                    log('   2. Medi√ß√µes sem medicao_items (exclu√≠das pelo !inner)', 'warning');
                    log('   3. Apenas medi√ß√µes tipo "Foto"', 'warning');
                    return;
                }

                // Contar tipos v√°lidos
                const tiposValidos = new Set();
                data.forEach(m => {
                    m.medicao_items.forEach(item => {
                        const tipo = item.tipo_medicao?.nome;
                        if (tipo && tipo !== 'Foto') {
                            tiposValidos.add(tipo);
                        }
                    });
                });

                if (tiposValidos.size === 0) {
                    log('‚ùå PROBLEMA: Dados encontrados mas apenas tipo "Foto"', 'error');
                    log('üí° Adicione medi√ß√µes de tipos num√©ricos', 'warning');
                    return;
                }

                log('‚úÖ Query do frontend funcionaria corretamente!', 'success');
                log(`   Medi√ß√µes: ${data.length}`, 'success');
                log(`   Tipos v√°lidos: ${Array.from(tiposValidos).join(', ')}`, 'success');
                log('üí° Se o gr√°fico n√£o aparece, o problema est√° no frontend', 'warning');
                log('üí° Abra o Console do navegador (F12) e procure por erros', 'warning');

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

            await runTest1();
            if (window.pontoId) {
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                await runTest2();
                if (window.medicoes) {
                    log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                    await runTest3();
                }
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
                await runTest4();
            }

            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
            log('‚úÖ Diagn√≥stico completo!', 'success');
        }
    </script>
</body>
</html>
